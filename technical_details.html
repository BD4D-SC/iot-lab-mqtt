<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Technical details &#8212; IoT-LAB MQTT 0.4.1 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.4.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Agents" href="agents.html" />
    <link rel="prev" title="Agent Design choices" href="design_choices.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="technical-details">
<h1>Technical details<a class="headerlink" href="#technical-details" title="Permalink to this headline">¶</a></h1>
<div class="section" id="topics-format">
<h2>Topics format<a class="headerlink" href="#topics-format" title="Permalink to this headline">¶</a></h2>
<p>MQTT topics are a one way packet transport system.
More advanced communication scheme need using multiple topics with some
specific interfaces.</p>
<p>This section describes the different communication mechanisms used,
topic naming conventions and message format.</p>
<div class="section" id="channels">
<span id="channeltopic"></span><h3>Channels<a class="headerlink" href="#channels" title="Permalink to this headline">¶</a></h3>
<p>Two way stream require having one topic for one communication side and
one for the other.
This includes serial port forwarding where one topic is used to
read from the serial port and one to write to it.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">input topic:</th><td class="field-body"><code class="docutils literal"><span class="pre">{resourcetopic}/data/in</span></code></td>
</tr>
<tr class="field-even field"><th class="field-name">output topic:</th><td class="field-body"><code class="docutils literal"><span class="pre">{resourcetopic}/data/out</span></code></td>
</tr>
</tbody>
</table>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h4>
<p>For a resource at <code class="docutils literal"><span class="pre">{prefix}/resource/1</span></code>, the channels topics will be:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Topic for writing to the resource</span>
<span class="p">{</span><span class="n">prefix</span><span class="p">}</span><span class="o">/</span><span class="n">resource</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="ow">in</span>
<span class="c1"># Topic where the resource writes its output</span>
<span class="p">{</span><span class="n">prefix</span><span class="p">}</span><span class="o">/</span><span class="n">resource</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="request-model">
<span id="requesttopic"></span><h3>Request model<a class="headerlink" href="#request-model" title="Permalink to this headline">¶</a></h3>
<p>Requests allow executing commands on a resource is a form of two way stream,
one to do the request and one to give the result.
As a response must correspond to the right request and the right client,
a per request/client topic should be specified.</p>
<p>The chosen format is the following:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">request topic:</th><td class="field-body"><code class="docutils literal"><span class="pre">{resourcetopic}/ctl/{command}/request/{clientid}/{requestid}</span></code></td>
</tr>
<tr class="field-even field"><th class="field-name">reply topic:</th><td class="field-body"><code class="docutils literal"><span class="pre">{resourcetopic}/ctl/{command}/reply/{clientid}/{requestid}</span></code></td>
</tr>
</tbody>
</table>
<p>In practice, using topic wildcard topic subscribe, only one subscribe is
necessary per agent/client/request/command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Agent subscribe</span>
<span class="p">{</span><span class="n">prefix</span><span class="p">}</span><span class="o">/</span><span class="n">resource</span><span class="o">/</span><span class="n">topic</span><span class="o">/</span><span class="n">ctl</span><span class="o">/</span><span class="p">{</span><span class="n">command</span><span class="p">}</span><span class="o">/</span><span class="n">request</span><span class="o">/+/+</span>
<span class="c1"># Client subscribe</span>
<span class="p">{</span><span class="n">prefix</span><span class="p">}</span><span class="o">/</span><span class="n">resource</span><span class="o">/</span><span class="n">topic</span><span class="o">/</span><span class="n">ctl</span><span class="o">/</span><span class="p">{</span><span class="n">command</span><span class="p">}</span><span class="o">/</span><span class="n">reply</span><span class="o">/</span><span class="p">{</span><span class="n">clientid</span><span class="p">}</span><span class="o">/+</span>
</pre></div>
</div>
<p>For <code class="docutils literal"><span class="pre">clientid</span></code> I recommend using a readable identifier concatenated to an
UUID to ensure both readability and unicity.</p>
</div>
<div class="section" id="error-topic">
<span id="errortopic"></span><h3>Error topic<a class="headerlink" href="#error-topic" title="Permalink to this headline">¶</a></h3>
<p>As not all the following communication mechanisms have a response,
asynchronous errors or failures happen on an error topic.</p>
<p>The errors are sent to a subtopic from the agent error topic.
They are published to the concatenation of the agent error topic
and the topic where error happend relative to the agent topic:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">agenttopic</span><span class="p">}</span><span class="o">/</span><span class="n">error</span><span class="o">/</span><span class="n">relative</span><span class="o">/</span><span class="n">topic</span><span class="o">/</span><span class="n">where</span><span class="o">/</span><span class="n">problem</span><span class="o">/</span><span class="n">occured</span>
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">payload:</th><td class="field-body"><code class="docutils literal"><span class="pre">utf-8</span> <span class="pre">encoded</span> <span class="pre">strings</span></code>.</td>
</tr>
</tbody>
</table>
<p>Clients subscribe to errors for this agent with:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">agenttopic</span><span class="p">}</span><span class="o">/</span><span class="n">error</span><span class="o">/</span><span class="c1">#</span>
</pre></div>
</div>
<div class="section" id="id1">
<h4>Example<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>An error in resource <code class="docutils literal"><span class="pre">{agenttopic}/resource/1</span></code> will be published to:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">agenttopic</span><span class="p">}</span><span class="o">/</span><span class="n">error</span><span class="o">/</span><span class="n">resource</span><span class="o">/</span><span class="mi">1</span>
</pre></div>
</div>
<p>An error in the general agent to the will be published to:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">agenttopic</span><span class="p">}</span><span class="o">/</span><span class="n">error</span><span class="o">/</span>    <span class="c1"># With the trailing `/`</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="sending-both-utf-8-and-binary-in-a-message">
<h2>Sending both UTF-8 and binary in a message<a class="headerlink" href="#sending-both-utf-8-and-binary-in-a-message" title="Permalink to this headline">¶</a></h2>
<p>In the case of firmware update, the message will need to contain both a list of
nodes and a firmware binary. It has been chosen to separate the UTF-8 string
from the binary payload using <code class="docutils literal"><span class="pre">0xFF</span></code> byte.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="n">encoded</span> <span class="n">JSON</span> <span class="n">string</span><span class="o">&gt;</span> <span class="mh">0xFF</span> <span class="o">&lt;</span><span class="n">Binary</span> <span class="n">data</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>In fact, <code class="docutils literal"><span class="pre">0xFF</span></code> is never used in a UTF-8 encoded string <a class="reference external" href="https://en.wikipedia.org/wiki/UTF-8#Advantages_2">wikipedia:utf-8</a>
so the payload can safely be split of the first occurence of <code class="docutils literal"><span class="pre">0xFF</span></code> without
requiring to try decoding the string.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Technical details</a><ul>
<li><a class="reference internal" href="#topics-format">Topics format</a><ul>
<li><a class="reference internal" href="#channels">Channels</a><ul>
<li><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#request-model">Request model</a></li>
<li><a class="reference internal" href="#error-topic">Error topic</a><ul>
<li><a class="reference internal" href="#id1">Example</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#sending-both-utf-8-and-binary-in-a-message">Sending both UTF-8 and binary in a message</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="design_choices.html" title="previous chapter">Agent Design choices</a></li>
      <li>Next: <a href="agents.html" title="next chapter">Agents</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/technical_details.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Gaëtan Harter.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="_sources/technical_details.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>